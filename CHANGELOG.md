# AI Learning Assistant - 更新日志

所有版本变更记录均在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [Semantic Versioning](https://semver.org/lang/zh-CN/)。

## [1.5.1] - 2026-02-15

### 已修复

- **教学阶段工具调用回调缺失**：修复了AI调用工具后没有继续生成回复的问题
  
  - 根本原因：原代码只执行了工具，但没有将工具结果返回给LLM让其继续生成
  - 修复方案：完整实现OpenAI标准工具调用流程
    - 第一次调用：获取AI的工具调用请求
    - 执行工具并获取结果
    - 第二次调用：将工具结果返回给LLM，让其基于结果继续生成回复
    - 保存完整对话历史到工作区
  - 现在AI会在调用工具后自动继续对话，比如"我已经为你创建了笔记文件"或"让我们来做这道题"

- **空回复问题彻底修复**：修复了end_inquiry调用后前端显示空消息的问题
  
  - 前端改进：延迟创建消息容器，直到确实收到内容才开始显示
  - 智能处理：如果AI调用了end_inquiry且没有生成内容，自动跳过空消息显示
  - 添加endInquiryCalled标记，更准确地识别询问完成场景

- **工具参数理解问题**：优化工具定义和提示词，帮助AI正确调用工具
  
  - 增强工具描述：明确说明每个工具的"调用时机"和"调用后必须做什么"
  - 添加调用示例：为每个工具提供具体的JSON调用示例
  - 改进参数说明：强调action参数必须使用小写英文（read/write/edit/delete/mkdir）
  - 流程说明：在提示词中明确说明工具调用流程（调用工具→系统执行→基于结果继续回复）

### 技术细节

- **后端架构改进**：
  - `teaching_chat`函数实现完整的两轮LLM调用流程
  - 改进工具参数解析，支持流式接收tool_calls
  - 保存包含tool_calls的完整对话历史
  - 修复类型注解问题，`List[Dict]`改为`List[Dict[str, Any]]`

- **前端优化**：
  - `sendInquiryMessage`函数重构，延迟消息容器创建
  - 添加`hasContentStarted`和`endInquiryCalled`状态跟踪
  - 改进空消息检测和处理逻辑

## [1.5.0] - 2026-02-15

### 已修复

- **自动进入教学阶段问题**：修复AI调用`end_inquiry`后仍需手动点击按钮的问题
  
  - 后端：修复`inquiry_chat`函数，确保正确发送`tool_call`完成状态和`inquiry_complete`信号
  - 前端：修复`sendInquiryMessage`函数，确保`inquiryComplete`状态正确触发`generateStudyPlan()`
  - 日志：添加详细的调试日志，帮助诊断流程问题

- **空消息显示问题**：修复AI调用`end_inquiry`后生成空消息在前端显示的问题
  
  - 前端：在`sendInquiryMessage`函数的`data.done`处理中，检查`fullResponse`是否为空
  - 如果为空，自动移除消息容器，避免显示空消息
  - 确保只有有实际内容的消息才添加到历史记录

- **练习生成工具问题**：修复AI调用`generate_exercise`工具但参数不完整的问题
  
  - 后端：增强`_generate_exercise`函数的错误信息，提供详细的参数要求和调用示例
  - 错误信息现在包含`required_params`、`current_params`、`missing`和`example`字段
  - 确保AI收到清晰的错误提示后能重新正确调用工具

- **暗色模式问题**：修复首页暗色模式无法正常切换的问题
  
  - 统一主题管理：首页现在使用`main.js`中的`ThemeManager`统一管理主题
  - 修复主题状态不一致问题，确保首页和聊天页面主题同步
  - 添加备用方案，确保即使`main.js`未加载也能正常切换主题

### 新增

- **增强的错误处理机制**：
  
  - `_generate_exercise`函数添加详细的错误信息，帮助AI理解参数要求
  - 提供完整的调用示例和参数说明
  - 错误信息结构化，便于AI解析和重新调用

- **统一的主题管理系统**：
  
  - 首页和聊天页面使用相同的主题管理逻辑
  - 确保主题状态在整个应用中保持一致
  - 添加健壮的备用方案，防止主题切换失败

### 变更

- **后端工具调用优化**：
  
  - `inquiry_chat`函数现在同时发送`tool_call`完成状态和`inquiry_complete`信号
  - 确保前端能正确识别询问完成状态并自动触发学习计划生成
  - 改进错误处理，即使工具调用失败也能正确结束询问阶段

- **前端消息处理优化**：
  
  - 优化空消息检测和处理逻辑
  - 改进工具调用状态显示的一致性
  - 增强调试日志，便于问题诊断

## [1.4.2] - 2026-02-15

### 已修复

- **工具调用参数不完整问题**：修复AI调用`file_system`工具但参数为空的问题
  
  - 优化`prompts.yml`中`file_system`工具的详细说明，添加具体调用示例
  - 增强`_file_system`函数参数验证，提供详细的错误提示和修复建议
  - 确保AI收到错误信息后能重新正确调用工具

- **教学阶段流程阻塞问题**：修复AI调用`end_inquiry`后仍需手动点击按钮的问题
  
  - 改进前端`inquiryComplete`状态管理，确保自动触发学习计划生成
  - 修复`inquiryHistory`更新逻辑，确保包含完整的对话历史
  - 添加调试日志帮助诊断流程问题

- **工具调用状态显示不完整**：增强工具调用可视化反馈
  
  - 在聊天区域添加工具调用状态消息，显示工具名称、状态和结果
  - 支持错误信息显示和修复提示，帮助用户理解问题
  - 添加美观的CSS样式区分不同工具状态

### 新增

- **工具调用可视化反馈**：
  
  - 新增`showToolCallInChat`函数，在聊天区域显示工具调用状态
  - 支持四种状态：开始、完成、错误、询问完成
  - 显示详细的错误信息和修复提示

- **增强的错误处理机制**：
  
  - `_file_system`工具添加完整的参数验证和错误提示
  - 工具执行失败时返回结构化错误信息，包含`error`和`hint`字段
  - 前端自动解析并显示工具调用结果

- **调试支持**：
  
  - 在关键流程添加`console.log`调试信息
  - 帮助开发者诊断工具调用和阶段切换问题

### 变更

- **工具提示词优化**：
  
  - 在`phase3_teaching`中添加`file_system`工具的具体调用示例
  - 明确要求AI必须提供完整的`action`和`path`参数
  - 添加`write`和`edit`操作的参数要求说明

- **前端交互优化**：
  
  - 改进工具状态条显示逻辑
  - 优化聊天区域工具消息的视觉设计
  - 增强用户对AI工具调用的感知

## [1.4.1] - 2026-02-15

### 已修复

- **练习题生成问题**：修复AI调用工具但不提供完整参数的问题
  
  - 优化`prompts.yml`中的工具提示词，明确要求AI提供完整题目内容
  - 增强`_generate_exercise`函数参数验证，防止生成空题目
  - 添加详细的错误提示，帮助AI正确调用工具

- **教学阶段流程问题**：修复`end_inquiry`工具调用失败
  
  - 改进JSON参数解析，处理空参数情况
  - 添加健壮的错误处理，即使工具调用失败也能继续流程
  - 确保询问阶段能正确结束并进入教学阶段

- **AI输出自动滚动问题**：优化消息显示体验
  
  - 修改流式响应处理，只在消息开始时滚动一次
  - 用户发送消息时滚动，AI回复时保持阅读位置
  - 避免频繁滚动干扰用户阅读

### 变更

- **工具提示词优化**：
  
  - 在`phase3_teaching`中添加详细的工具调用示例
  - 明确要求AI必须提供完整的题目参数
  - 添加工具调用频率和时机指导

- **后端错误处理增强**：
  
  - `_generate_exercise`函数添加参数验证逻辑
  - `end_inquiry`工具调用添加JSON解析容错
  - 工具执行失败时提供有意义的错误信息

- **前端滚动逻辑优化**：
  
  - 修改`appendMessage`函数，区分用户和AI消息滚动
  - 流式响应中减少不必要的滚动调用
  - 保持用户阅读体验的连贯性

## [1.4.0] - 2026-02-15

### 已修复

- **工具调用不符合OpenAI标准**：修复教学阶段工具调用逻辑
  
  - 后端完全遵循OpenAI工具调用规范：AI请求工具 -> 后端执行工具 -> 返回工具结果给AI
  - 修复工具调用流式处理，正确处理`tool_calls`字段
  - 确保工具执行结果正确保存到对话历史

- **AI不理解教学计划来源**：优化提示词让AI清楚上下文
  
  - 在phase3_teaching提示词中添加明确说明
  - 强调AI应基于已有计划教学，不要重复询问已收集的信息

- **前端工具调用处理问题**：修复前端工具调用解析逻辑
  
  - 移除旧的`<tool_call>`标签格式处理
  - 改为处理`data.exercise`事件，直接接收练习题数据
  - 修复formatMessage函数，移除对工具调用标签的隐藏处理

- **练习题显示问题**：实现右侧题目栏
  
  - 添加右侧练习题侧边栏，显示所有生成的练习题
  - 支持练习题分类、难度标识和快速访问
  - 响应式设计，在移动设备上可滑动打开
  - 练习题自动保存到列表，支持随时查看和答题

### 新增

- **右侧题目栏**：全新的练习题管理界面
  
  - 实时显示AI生成的所有练习题
  - 支持按类型和难度筛选查看
  - 一键开始答题或查看详情
  - 移动端友好的侧滑面板

- **OpenAI标准工具调用**：完全兼容OpenAI工具调用规范
  
  - 后端正确处理工具调用请求和响应
  - 支持多工具并行调用
  - 工具执行结果正确返回给AI继续对话

### 变更

- **后端架构**：
  
  - 重构`teaching_chat`函数，完全遵循OpenAI工具调用流程
  - 添加工具执行结果的消息保存逻辑
  - 优化工具调用错误处理

- **前端交互**：
  
  - 添加右侧题目栏HTML结构和CSS样式
  - 实现练习题列表管理和显示功能
  - 更新工具调用事件处理逻辑
  - 添加移动端题目栏切换按钮

- **提示词优化**：
  
  - 更新phase3_teaching提示词，明确学习计划来源
  - 优化工具调用说明，使用OpenAI标准格式
  - 增强AI主动引导教学的指令

## [1.3.0] - 2026-02-15

### 已修复

- **手动点击问题**：AI收集足够信息后自动生成学习计划，无需用户手动点击
  
  - 优化询问阶段提示词，AI在信息收集完成后自动调用`end_inquiry`工具
  - 前端自动检测工具调用并触发学习计划生成
  - 移除"生成学习计划"按钮的强制依赖，改为备用选项

- **教学阶段信息收集**：优化教学阶段提示词，防止AI重复收集信息
  
  - 明确禁止教学阶段重复询问已提供的信息
  - 强调主动引导教学，确保AI按照学习计划推进教学

- **预设信息显示**：教学阶段不再显示预设欢迎信息
  
  - 移除前端硬编码的教学开始消息
  - 改为发送空消息触发AI生成第一句话
  - 让AI根据学习计划自然开始教学

### 新增

- **对话记录JSON导出**：完整的标准格式导出功能
  
  - 后端`/api/workspaces/<id>/export` API端点
  - 包含元数据、完整对话、学习计划和文件结构
  - 标准JSON格式，便于分析和存档

- **现代化界面设计**：卡片式消息布局
  
  - 移除用户和AI头像，改用简洁卡片设计
  - 用户消息使用渐变背景，AI消息使用卡片阴影
  - 优化移动端响应式显示

- **智能教学策略**：优化教学阶段提示词
  
  - 要求AI每次教学必须主动推进：要么提问检查理解，要么出题巩固
  - 明确禁止被动等待学生提问
  - 确保工具调用符合OpenAI标准格式

### 变更

- **后端架构**：
  
  - 添加`export_conversation`路由支持完整对话导出
  - 更新`prompts.yml`优化询问和教学阶段提示词
  - 确保工具参数符合OpenAI标准

- **前端交互**：
  
  - 重构`appendMessage`函数使用卡片式布局
  - 更新`sendMessage`函数支持空消息自动触发
  - 修改`sendInquiryMessage`自动触发学习计划生成
  - 优化消息样式CSS，移除头像相关样式

- **用户界面**：
  
  - 更新消息卡片CSS样式
  - 优化移动端响应式设计
  - 改进颜色方案和视觉层次

### 技术细节

- **文件变更**：
  - `app.py`：添加导出API，优化工具调用
  - `prompts.yml`：全面优化询问和教学阶段提示词
  - `templates/chat.html`：重构消息显示逻辑和界面
  - `static/css/style.css`：更新消息卡片样式
  - `README.md`：更新版本说明和功能描述

## [1.2.0] - 2026-02-15

### 已修复

- **AI不会主动进入教学阶段**：添加`end_inquiry`工具，让AI可以主动结束询问
  
  - AI在收集足够信息后调用`end_inquiry`工具
  - 前端自动检测工具调用，高亮显示生成计划按钮
  - 移除不可靠的关键词检测逻辑

- **学习计划小题大做**：优化学习计划生成逻辑
  
  - 根据主题复杂度和用户背景自适应调整计划详细程度
  - 提供简单、中等、复杂三种计划模板
  - 强调简洁实用，避免过度复杂化

### 新增

- **提示词配置文件**：`prompts.yml`独立管理所有提示词
  
  - 包含询问阶段、计划生成、教学阶段等完整提示词
  - 支持变量替换和模板化
  - 便于维护和调整，无需修改代码

- **提示词管理器**：`PromptManager`类统一管理提示词
  
  - 自动加载`prompts.yml`配置文件
  - 提供默认提示词作为后备
  - 支持动态变量替换

- **前端动画效果**：
  
  - 生成学习计划按钮脉冲动画
  - 工具调用状态实时显示
  - 改进的通知系统

### 变更

- **后端架构**：
  
  - 重构提示词系统，从代码中分离到配置文件
  - 添加`end_inquiry`工具到`ToolExecutor`
  - 更新`inquiry_chat`路由支持工具调用
  - 所有提示词相关函数使用`PromptManager`

- **前端交互**：
  
  - 更新`sendInquiryMessage`函数处理工具调用
  - 添加按钮动画CSS样式
  - 改进工具状态显示逻辑

### 技术细节

- **文件变更**：
  
  - `prompts.yml`: 新增提示词配置文件
  - `app.py`: 添加`PromptManager`类，更新路由逻辑
  - `templates/chat.html`: 更新前端工具调用处理
  - `static/css/style.css`: 添加按钮动画样式
  - `AGENTS.md`: 更新常见问题修复部分
  - `README.md`: 更新版本信息

- **API变更**：
  
  - `inquiry_chat`路由现在支持工具调用
  - 新增`end_inquiry`工具定义
  - 提示词系统完全重构，但保持向后兼容

## [1.1.0] - 2026-02-15

### 已修复

- **阶段切换问题**：修复了AI在需求询问阶段就开始教学的问题
  
  - 强化`PHASE1_INQUIRY_PROMPT`提示词，明确禁止教学和工具使用
  - 添加明确的阶段结束信号："I have enough information now. Please click the 'Generate Study Plan' button..."
  - 前端添加"生成学习计划"按钮，只在询问阶段显示
  - 实现工作区状态持久化（`workspace_state.json`）

- **工作区状态持久化**：修复了加载现有工作区时阶段被硬编码为"teaching"的问题
  
  - 新增`workspace_state.json`文件保存工作区状态
  - 保存和恢复`current_phase`、`token_count`、`compressed_context`等状态
  - 确保应用重启后能从正确阶段继续

- **前端用户体验**：
  
  - 移除基于URL参数的阶段初始化（现在从后端获取）
  - 确保`inquiryHistory`在加载历史消息时正确初始化
  - 防止在已有历史消息时重复发送初始消息
  - 改进阶段指示器的更新逻辑

### 新增

- **工作区状态文件**：`workspace_state.json`包含：
  
  - `current_phase`: 当前阶段（init/inquiry/teaching）
  - `token_count`: 当前token计数
  - `token_threshold`: token阈值
  - `compressed_context`: 压缩的上下文内容

- **前端UI组件**：
  
  - "生成学习计划"按钮，带有渐变背景和动画效果
  - 改进的阶段指示器视觉反馈

### 变更

- **后端路由**：
  
  - `WorkspaceManager.save_workspace()`现在保存工作区状态
  - `WorkspaceManager.get_workspace()`从状态文件加载阶段信息
  - `inquiry_chat`路由明确不传递工具参数

- **前端JavaScript**：
  
  - 重构阶段初始化逻辑
  - 添加`updatePhaseIndicator()`函数统一管理阶段显示
  - 改进`startInquiry()`函数，防止重复发送初始消息

### 技术细节

- **文件变更**：
  
  - `app.py`: 修改提示词模板、工作区状态管理
  - `templates/chat.html`: 添加生成学习计划按钮，改进阶段逻辑
  - `static/css/style.css`: 添加按钮样式和动画
  - `AGENTS.md`: 更新常见问题修复部分
  - `structure.md`: 更新工作区文件结构说明

- **API变更**：
  
  - 新增`workspace_state.json`文件格式

## [1.0.0] - 2026-02-14

### 新增

- 初始版本发布
- 支持多LLM提供商（OpenAI、Google、Kimi、xAI、DeepSeek、OpenRouter等）
- 上下文压缩机制
- 工具调用系统（generate_exercise、web_search、file_system）
- 响应式UI设计，支持深色/浅色模式
- 工作区持久化系统

### 技术栈

- 后端：Python 3.8+, Flask
- 前端：HTML5, CSS3, JavaScript (ES6+)
- LLM协议：OpenAI API 格式
- 数据存储：本地文件系统 (JSON, Markdown)

---

## 维护指南

### 版本发布流程

1. 更新`CHANGELOG.md`文件
2. 更新`README.md`中的版本信息
3. 确保所有测试通过
4. 创建git tag：`git tag -a v1.1.0 -m "版本1.1.0：修复阶段切换问题"`
5. 推送tag：`git push origin v1.1.0`

### 版本号规则

- **主版本号（MAJOR）**：不兼容的API修改
- **次版本号（MINOR）**：向下兼容的功能性新增
- **修订号（PATCH）**：向下兼容的问题修正

### 文档更新要求

每次版本发布必须更新：

1. `CHANGELOG.md` - 详细变更记录
2. `AGENTS.md` - 开发者文档
3. `structure.md` - 项目结构文档
4. `README.md` - 用户文档（如有重大变更）

### 向后兼容性

- 保持现有工作区文件的兼容性
- 新增功能不应破坏现有工作流程
- 数据迁移需要提供明确的升级路径