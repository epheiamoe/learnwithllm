{% extends "base.html" %}

{% block title %}{{ theme }} - AI Learning Assistant{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                å·¥ä½œåŒº
            </h3>
            <button class="sidebar-toggle" id="sidebarToggle" title="æ”¶èµ·ä¾§è¾¹æ ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/>
                </svg>
            </button>
        </div>

        <!-- ä¸Šä¸‹æ–‡æŒ‡ç¤ºå™¨ -->
        <div class="context-indicator">
            <div class="context-header">
                <span class="context-label">ä¸Šä¸‹æ–‡ä½¿ç”¨</span>
                <span class="context-value" id="contextValue">0 / 0</span>
            </div>
            <div class="context-bar">
                <div class="context-fill" id="contextFill" style="width: 0%"></div>
            </div>
            <p class="context-hint" id="contextHint">æ­£å¸¸</p>
        </div>

        <!-- å­¦ä¹ é˜¶æ®µæŒ‡ç¤º -->
        <div class="phase-indicator" id="phaseIndicator">
            <div class="phase-item active" data-phase="inquiry">
                <div class="phase-dot"></div>
                <span>éœ€æ±‚è¯¢é—®</span>
            </div>
            <div class="phase-item" data-phase="teaching">
                <div class="phase-dot"></div>
                <span>æ­£å¼æ•™å­¦</span>
            </div>
        </div>

        <!-- æ–‡ä»¶æ ‘ -->
        <div class="file-tree-container">
            <h4 class="file-tree-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                æ–‡ä»¶
            </h4>
            <div class="file-tree" id="fileTree">
                <div class="file-tree-loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å­¦ä¹ è®¡åˆ’é“¾æ¥ -->
        <div class="study-plan-link" id="studyPlanLink" style="display: none;">
            <button class="btn btn-ghost btn-sm btn-block" onclick="showStudyPlan()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                æŸ¥çœ‹å­¦ä¹ è®¡åˆ’
            </button>
        </div>
    </aside>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <main class="chat-main">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <header class="chat-header">
            <div class="chat-title">
                <button class="sidebar-toggle-mobile" id="sidebarToggleMobile">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h2 id="chatTitle">{{ theme }}</h2>
            </div>
            <div class="chat-actions">
                <button class="btn btn-ghost btn-sm" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                <button class="btn btn-ghost btn-sm" onclick="exportChat()" title="å¯¼å‡ºå¯¹è¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div class="messages-container" id="messagesContainer">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">ğŸ‘‹</div>
                <h3>å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…</h3>
                <p>AIåŠ©æ‰‹ä¼šå…ˆè¯¢é—®å‡ ä¸ªé—®é¢˜ï¼Œäº†è§£ä½ çš„å­¦ä¹ éœ€æ±‚ï¼Œç„¶åä¸ºä½ åˆ¶å®šä¸“å±å­¦ä¹ è®¡åˆ’ã€‚</p>
            </div>
            <!-- æ¶ˆæ¯å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>

        <!-- å·¥å…·çŠ¶æ€æ  -->
        <div class="tool-status-bar" id="toolStatusBar" style="display: none;">
            <div class="tool-status-item">
                <span class="tool-status-spinner"></span>
                <span class="tool-status-text" id="toolStatusText">å¤„ç†ä¸­...</span>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea
                    id="messageInput"
                    class="message-input"
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    rows="1"
                    onkeypress="handleKeyPress(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
            <p class="input-hint">æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</p>

            <!-- ç”Ÿæˆå­¦ä¹ è®¡åˆ’æŒ‰é’®ï¼ˆä»…åœ¨è¯¢é—®é˜¶æ®µæ˜¾ç¤ºï¼‰ -->
            <div class="generate-plan-container" id="generatePlanContainer" style="display: none;">
                <button class="btn btn-primary btn-block" onclick="generateStudyPlan()" id="generatePlanBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    ç”Ÿæˆå­¦ä¹ è®¡åˆ’
                </button>
                <p class="plan-hint">å½“AIè¡¨ç¤ºå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯æ—¶ï¼Œç‚¹å‡»æ­¤æŒ‰é’®ç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’</p>
            </div>
        </div>
    </main>
</div>

<!-- å­¦ä¹ è®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal modal-large" id="studyPlanModal">
    <div class="modal-overlay" onclick="hideStudyPlan()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>å­¦ä¹ è®¡åˆ’</h3>
            <button class="modal-close" onclick="hideStudyPlan()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="markdown-content" id="studyPlanContent">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
</div>

<!-- ç»ƒä¹ é¢˜æ¨¡æ€æ¡† -->
<div class="modal" id="exerciseModal">
    <div class="modal-overlay" onclick="hideExercise()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç»ƒä¹ é¢˜</h3>
            <span class="exercise-difficulty" id="exerciseDifficulty">ä¸­ç­‰</span>
            <button class="modal-close" onclick="hideExercise()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="exercise-content" id="exerciseContent">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="exercise-result" id="exerciseResult" style="display: none;">
                <!-- ç­”é¢˜ç»“æœ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideExercise()">å…³é—­</button>
            <button class="btn btn-primary" id="submitExerciseBtn" onclick="submitExercise()">æäº¤ç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal modal-large" id="filePreviewModal">
    <div class="modal-overlay" onclick="hideFilePreview()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="filePreviewTitle">æ–‡ä»¶é¢„è§ˆ</h3>
            <button class="modal-close" onclick="hideFilePreview()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <pre class="file-preview-content" id="filePreviewContent"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€çŠ¶æ€
const workspaceId = '{{ workspace_id }}';
let currentPhase = 'inquiry';
let inquiryHistory = [];
let isGenerating = false;
let currentExercise = null;
let tokenCount = 0;
let tokenThreshold = 0;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadWorkspaceData();
    loadFileTree();
});

// åŠ è½½å·¥ä½œåŒºæ•°æ®
async function loadWorkspaceData() {
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/messages`);
        const data = await response.json();
        
        if (data.success) {
            currentPhase = data.phase;
            tokenCount = data.token_count;
            tokenThreshold = data.token_threshold;
            
            updateContextIndicator();
            updatePhaseIndicator();
            
            // å¦‚æœæœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå®ƒä»¬å¹¶åˆå§‹åŒ–inquiryHistory
            if (data.messages && data.messages.length > 0) {
                document.getElementById('welcomeMessage').style.display = 'none';
                data.messages.forEach(msg => {
                    if (msg.role !== 'system') {
                        appendMessage(msg.role, msg.content);
                        // æ·»åŠ åˆ°inquiryHistoryï¼ˆç”¨äºç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼‰
                        if (currentPhase === 'inquiry' || currentPhase === 'init') {
                            inquiryHistory.push({ role: msg.role, content: msg.content });
                        }
                    }
                });
            }
            
            // æ ¹æ®é˜¶æ®µæ˜¾ç¤ºç›¸åº”å†…å®¹
            if (currentPhase === 'teaching') {
                // æ•™å­¦é˜¶æ®µï¼šæ˜¾ç¤ºå­¦ä¹ è®¡åˆ’é“¾æ¥
                document.getElementById('studyPlanLink').style.display = 'block';
                document.getElementById('welcomeMessage').style.display = 'none';
            } else if (currentPhase === 'init' || currentPhase === 'inquiry') {
                // åˆå§‹åŒ–æˆ–è¯¢é—®é˜¶æ®µï¼šå¼€å§‹è¯¢é—®
                startInquiry();
            }
        }
    } catch (error) {
        console.error('åŠ è½½å·¥ä½œåŒºæ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°ä¸Šä¸‹æ–‡æŒ‡ç¤ºå™¨
function updateContextIndicator() {
    const percentage = tokenThreshold > 0 ? (tokenCount / tokenThreshold * 100) : 0;
    const contextValue = document.getElementById('contextValue');
    const contextFill = document.getElementById('contextFill');
    const contextHint = document.getElementById('contextHint');
    
    const maxContext = Math.round(tokenThreshold / 0.8 / 1000);
    contextValue.textContent = `${Math.round(tokenCount / 1000)}K / ${maxContext}K`;
    contextFill.style.width = `${Math.min(percentage, 100)}%`;
    
    if (percentage < 50) {
        contextFill.className = 'context-fill';
        contextHint.textContent = 'æ­£å¸¸';
        contextHint.className = 'context-hint';
    } else if (percentage < 80) {
        contextFill.className = 'context-fill warning';
        contextHint.textContent = 'æ¥è¿‘é˜ˆå€¼';
        contextHint.className = 'context-hint warning';
    } else {
        contextFill.className = 'context-fill danger';
        contextHint.textContent = 'å·²å‹ç¼©';
        contextHint.className = 'context-hint danger';
    }
}

// æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
function updatePhaseIndicator() {
    const items = document.querySelectorAll('.phase-item');
    items.forEach(item => {
        const phase = item.dataset.phase;
        if (phase === currentPhase) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    // æ›´æ–°ç”Ÿæˆå­¦ä¹ è®¡åˆ’æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
    const generatePlanContainer = document.getElementById('generatePlanContainer');
    if (currentPhase === 'inquiry') {
        generatePlanContainer.style.display = 'block';
    } else {
        generatePlanContainer.style.display = 'none';
    }
}

// å¼€å§‹è¯¢é—®é˜¶æ®µ
function startInquiry() {
    currentPhase = 'inquiry';
    updatePhaseIndicator();

    // åªæœ‰åœ¨æ²¡æœ‰å†å²æ¶ˆæ¯æ—¶æ‰å‘é€åˆå§‹æ¶ˆæ¯
    if (inquiryHistory.length === 0) {
        const welcomeMsg = `ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå­¦ä¹ åŠ©æ‰‹ã€‚ä½ æƒ³å­¦ä¹ "{{ theme }}"ï¼Œè¿™æ˜¯ä¸ªå¾ˆæ£’çš„é€‰æ‹©ï¼

ä¸ºäº†ç»™ä½ åˆ¶å®šæœ€åˆé€‚çš„å­¦ä¹ è®¡åˆ’ï¼Œæˆ‘æƒ³å…ˆäº†è§£å‡ ä¸ªæƒ…å†µï¼š

1. **ä½ çš„å­¦ä¹ ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ** æ˜¯æƒ³å…¥é—¨äº†è§£ã€ç³»ç»Ÿå­¦ä¹ ï¼Œè¿˜æ˜¯è§£å†³æŸä¸ªå…·ä½“é—®é¢˜ï¼Ÿ

è¯·éšæ„å›ç­”ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„æƒ…å†µç»§ç»­æé—®ã€‚`;

        setTimeout(() => {
            appendMessage('assistant', welcomeMsg);
            inquiryHistory.push({ role: 'assistant', content: welcomeMsg });
        }, 500);
    }
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    if (isGenerating) return;
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.value = '';
    autoResize(input);
    
    appendMessage('user', message);
    
    if (currentPhase === 'inquiry') {
        inquiryHistory.push({ role: 'user', content: message });
        await sendInquiryMessage(message);
    } else {
        await sendTeachingMessage(message);
    }
}

// å‘é€è¯¢é—®é˜¶æ®µæ¶ˆæ¯
async function sendInquiryMessage(message) {
    isGenerating = true;
    showToolStatus('AIæ­£åœ¨æ€è€ƒ...', true);
    
    const responseDiv = appendMessage('assistant', '', true);
    let fullResponse = '';
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/inquiry`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: inquiryHistory
            })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6);
                    if (dataStr === '[DONE]') continue;
                    
                    try {
                        const data = JSON.parse(dataStr);
                        
                        if (data.error) {
                            responseDiv.innerHTML = `<span class="error">é”™è¯¯: ${data.error}</span>`;
                            isGenerating = false;
                            showToolStatus('', false);
                            return;
                        }
                        
                        if (data.content) {
                            fullResponse += data.content;
                            responseDiv.innerHTML = formatMessage(fullResponse);
                            scrollToBottom();
                        }
                        
                        if (data.done) {
                            inquiryHistory.push({ role: 'assistant', content: fullResponse });
                        }
                    } catch (e) {
                        console.error('è§£æé”™è¯¯:', e);
                    }
                }
            }
        }
    } catch (error) {
        responseDiv.innerHTML = `<span class="error">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`;
        console.error(error);
    } finally {
        isGenerating = false;
        showToolStatus('', false);
    }
}

// åˆ¤æ–­æ˜¯å¦ç»“æŸè¯¢é—®
function shouldEndInquiry(response) {
    const indicators = [
        'å‡†å¤‡åˆ¶å®šå­¦ä¹ è®¡åˆ’',
        'å¯ä»¥å¼€å§‹åˆ¶å®šè®¡åˆ’',
        'å·²ç»äº†è§£è¶³å¤Ÿ',
        'è®©æˆ‘ä¸ºä½ åˆ¶å®š',
        'ready to create',
        'create a study plan'
    ];
    
    const lowerResponse = response.toLowerCase();
    return indicators.some(ind => lowerResponse.includes(ind.toLowerCase()));
}

// ç”Ÿæˆå­¦ä¹ è®¡åˆ’
async function generateStudyPlan() {
    showToolStatus('æ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...', true);
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: inquiryHistory })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentPhase = 'teaching';
            updatePhaseIndicator();
            
            // æ˜¾ç¤ºæ•™å­¦å¼€å§‹æ¶ˆæ¯
            const startMsg = `[æ•™å­¦å¼€å§‹] å·²æ ¹æ®æ‚¨çš„éœ€æ±‚åˆ¶å®šå­¦ä¹ è®¡åˆ’ï¼Œç°åœ¨å¼€å§‹æ­£å¼å­¦ä¹ ...

ä½ å¯ä»¥éšæ—¶é—®æˆ‘é—®é¢˜ï¼Œæˆ‘ä¼šæ ¹æ®è®¡åˆ’å¼•å¯¼ä½ å­¦ä¹ ã€‚ç‚¹å‡»å·¦ä¾§"æŸ¥çœ‹å­¦ä¹ è®¡åˆ’"å¯ä»¥éšæ—¶æŸ¥çœ‹å®Œæ•´çš„å­¦ä¹ å¤§çº²ã€‚`;
            
            appendMessage('assistant', startMsg);
            document.getElementById('studyPlanLink').style.display = 'block';
            
            showNotification('å­¦ä¹ è®¡åˆ’å·²ç”Ÿæˆ', 'success');
        } else {
            showNotification(data.error || 'ç”Ÿæˆå¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ç½‘ç»œé”™è¯¯', 'error');
        console.error(error);
    } finally {
        showToolStatus('', false);
    }
}

// å‘é€æ•™å­¦é˜¶æ®µæ¶ˆæ¯
async function sendTeachingMessage(message) {
    isGenerating = true;
    showToolStatus('AIæ­£åœ¨æ€è€ƒ...', true);
    
    const responseDiv = appendMessage('assistant', '', true);
    let fullResponse = '';
    let hasExercise = false;
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6);
                    if (dataStr === '[DONE]') continue;
                    
                    try {
                        const data = JSON.parse(dataStr);
                        
                        if (data.error) {
                            responseDiv.innerHTML = `<span class="error">é”™è¯¯: ${data.error}</span>`;
                            isGenerating = false;
                            showToolStatus('', false);
                            return;
                        }
                        
                        if (data.content) {
                            fullResponse += data.content;
                            responseDiv.innerHTML = formatMessage(fullResponse);
                            scrollToBottom();
                        }
                        
                        if (data.tool_call) {
                            showToolStatus(`æ­£åœ¨${getToolName(data.tool_call.name)}...`, true);
                        }
                        
                        if (data.status === 'context_compressed') {
                            showNotification('ä¸Šä¸‹æ–‡å·²è‡ªåŠ¨å‹ç¼©', 'info');
                            updateContextIndicator();
                        }
                        
                        if (data.done) {
                            tokenCount = data.token_count || tokenCount;
                            updateContextIndicator();
                            
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«ç»ƒä¹ é¢˜
                            const exerciseMatch = fullResponse.match(/<tool_call>.*?"name":\s*"generate_exercise".*?<\/tool_call>/);
                            if (exerciseMatch && !hasExercise) {
                                hasExercise = true;
                                setTimeout(() => {
                                    parseAndShowExercise(exerciseMatch[0]);
                                }, 500);
                            }
                        }
                    } catch (e) {
                        console.error('è§£æé”™è¯¯:', e);
                    }
                }
            }
        }
    } catch (error) {
        responseDiv.innerHTML = `<span class="error">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`;
        console.error(error);
    } finally {
        isGenerating = false;
        showToolStatus('', false);
    }
}

// è·å–å·¥å…·åç§°
function getToolName(name) {
    const names = {
        'generate_exercise': 'ç”Ÿæˆç»ƒä¹ é¢˜',
        'web_search': 'æœç´¢ç½‘ç»œ',
        'file_system': 'æ“ä½œæ–‡ä»¶'
    };
    return names[name] || name;
}

// æ˜¾ç¤ºå·¥å…·çŠ¶æ€
function showToolStatus(text, show) {
    const bar = document.getElementById('toolStatusBar');
    const statusText = document.getElementById('toolStatusText');
    
    if (show && text) {
        statusText.textContent = text;
        bar.style.display = 'flex';
    } else {
        bar.style.display = 'none';
    }
}

// è§£æå¹¶æ˜¾ç¤ºç»ƒä¹ é¢˜
function parseAndShowExercise(toolCallStr) {
    try {
        const jsonMatch = toolCallStr.match(/<tool_call>(.*?)<\/tool_call>/s);
        if (jsonMatch) {
            const toolCall = JSON.parse(jsonMatch[1]);
            const params = toolCall.parameters;
            
            currentExercise = params;
            showExercise(params);
        }
    } catch (e) {
        console.error('è§£æç»ƒä¹ é¢˜å¤±è´¥:', e);
    }
}

// æ˜¾ç¤ºç»ƒä¹ é¢˜
function showExercise(exercise) {
    const modal = document.getElementById('exerciseModal');
    const content = document.getElementById('exerciseContent');
    const difficulty = document.getElementById('exerciseDifficulty');
    const result = document.getElementById('exerciseResult');
    
    difficulty.textContent = exercise.difficulty === 'easy' ? 'ç®€å•' : 
                             exercise.difficulty === 'hard' ? 'å›°éš¾' : 'ä¸­ç­‰';
    difficulty.className = `exercise-difficulty ${exercise.difficulty}`;
    result.style.display = 'none';
    
    let html = `<div class="exercise-question">${formatMessage(exercise.question)}</div>`;
    
    if (exercise.type === 'choice' && exercise.options) {
        html += '<div class="exercise-options">';
        exercise.options.forEach((opt, idx) => {
            html += `
                <label class="exercise-option">
                    <input type="radio" name="exercise_answer" value="${idx}">
                    <span>${escapeHtml(opt)}</span>
                </label>
            `;
        });
        html += '</div>';
    } else if (exercise.type === 'fill_blank' && exercise.blanks) {
        html += '<div class="exercise-blanks">';
        exercise.blanks.forEach((blank, idx) => {
            html += `
                <div class="exercise-blank">
                    <label>å¡«ç©º ${idx + 1}:</label>
                    <input type="text" class="form-input blank-input" data-index="${idx}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                </div>
            `;
        });
        html += '</div>';
    } else {
        html += `
            <div class="exercise-answer-area">
                <textarea class="form-input" id="exerciseAnswer" rows="4" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ"></textarea>
            </div>
        `;
    }
    
    content.innerHTML = html;
    modal.classList.add('active');
}

// æäº¤ç»ƒä¹ é¢˜ç­”æ¡ˆ
async function submitExercise() {
    if (!currentExercise) return;
    
    let answers = [];
    
    if (currentExercise.type === 'choice') {
        const selected = document.querySelector('input[name="exercise_answer"]:checked');
        if (!selected) {
            showNotification('è¯·é€‰æ‹©ç­”æ¡ˆ', 'warning');
            return;
        }
        answers = [selected.value];
    } else if (currentExercise.type === 'fill_blank') {
        const inputs = document.querySelectorAll('.blank-input');
        inputs.forEach(input => {
            answers.push(input.value.trim());
        });
    } else {
        const answer = document.getElementById('exerciseAnswer').value.trim();
        if (!answer) {
            showNotification('è¯·è¾“å…¥ç­”æ¡ˆ', 'warning');
            return;
        }
        answers = [answer];
    }
    
    // å®¢è§‚é¢˜ç›´æ¥éªŒè¯
    if (['choice', 'fill_blank', 'match', 'multi_fill'].includes(currentExercise.type)) {
        const correct = JSON.stringify(answers) === JSON.stringify(currentExercise.correct_answers);
        showExerciseResult(correct, currentExercise.explanation);
    } else {
        // ä¸»è§‚é¢˜éœ€è¦AIæ‰¹æ”¹
        showNotification('ä¸»è§‚é¢˜éœ€è¦AIæ‰¹æ”¹ï¼ŒåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
}

// æ˜¾ç¤ºç»ƒä¹ ç»“æœ
function showExerciseResult(correct, explanation) {
    const result = document.getElementById('exerciseResult');
    result.innerHTML = `
        <div class="result-status ${correct ? 'correct' : 'incorrect'}">
            <span class="result-icon">${correct ? 'âœ“' : 'âœ—'}</span>
            <span class="result-text">${correct ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}</span>
        </div>
        <div class="result-explanation">
            <strong>è§£æï¼š</strong>
            <p>${formatMessage(explanation)}</p>
        </div>
    `;
    result.style.display = 'block';
}

function hideExercise() {
    document.getElementById('exerciseModal').classList.remove('active');
    currentExercise = null;
}

// åŠ è½½æ–‡ä»¶æ ‘
async function loadFileTree() {
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/files`);
        const data = await response.json();
        
        if (data.success) {
            renderFileTree(data.files);
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
    }
}

// æ¸²æŸ“æ–‡ä»¶æ ‘
function renderFileTree(files) {
    const container = document.getElementById('fileTree');
    
    if (files.length === 0) {
        container.innerHTML = '<div class="file-tree-empty">æš‚æ— æ–‡ä»¶</div>';
        return;
    }
    
    const grouped = groupFilesByDir(files);
    container.innerHTML = renderFileGroup(grouped, 0);
}

function groupFilesByDir(files) {
    const root = { name: '', children: {}, files: [] };
    
    files.forEach(file => {
        const parts = file.path.split('/');
        let current = root;
        
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!current.children[part]) {
                current.children[part] = { name: part, children: {}, files: [] };
            }
            current = current.children[part];
        }
        
        current.files.push(file);
    });
    
    return root;
}

function renderFileGroup(group, level) {
    let html = '';
    
    // æ¸²æŸ“å­ç›®å½•
    for (const [name, child] of Object.entries(group.children)) {
        html += `
            <div class="file-tree-folder" style="padding-left: ${level * 12}px">
                <div class="file-tree-folder-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>${escapeHtml(name)}</span>
                </div>
                <div class="file-tree-folder-content">
                    ${renderFileGroup(child, level + 1)}
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“æ–‡ä»¶
    for (const file of group.files) {
        const fileName = file.name;
        html += `
            <div class="file-tree-item" style="padding-left: ${level * 12 + 20}px" 
                 onclick="previewFile('${file.path}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>${escapeHtml(fileName)}</span>
            </div>
        `;
    }
    
    return html;
}

// é¢„è§ˆæ–‡ä»¶
async function previewFile(filePath) {
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/files/${encodeURIComponent(filePath)}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('filePreviewTitle').textContent = filePath;
            document.getElementById('filePreviewContent').textContent = data.content;
            document.getElementById('filePreviewModal').classList.add('active');
        } else {
            showNotification(data.error || 'åŠ è½½å¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ç½‘ç»œé”™è¯¯', 'error');
        console.error(error);
    }
}

function hideFilePreview() {
    document.getElementById('filePreviewModal').classList.remove('active');
}

// æ˜¾ç¤ºå­¦ä¹ è®¡åˆ’
async function showStudyPlan() {
    try {
        const response = await fetch(`/api/workspaces/${workspaceId}/files/study_plan.md`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('studyPlanContent').innerHTML = formatMessage(data.content);
            document.getElementById('studyPlanModal').classList.add('active');
        } else {
            showNotification('å­¦ä¹ è®¡åˆ’å°šæœªç”Ÿæˆ', 'warning');
        }
    } catch (error) {
        showNotification('åŠ è½½å¤±è´¥', 'error');
        console.error(error);
    }
}

function hideStudyPlan() {
    document.getElementById('studyPlanModal').classList.remove('active');
}

// æ¶ˆæ¯å¤„ç†
function appendMessage(role, content, isStreaming = false) {
    const container = document.getElementById('messagesContainer');
    const welcomeMsg = document.getElementById('welcomeMessage');
    
    if (welcomeMsg) {
        welcomeMsg.style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;
    
    const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    const name = role === 'user' ? 'ä½ ' : 'AIåŠ©æ‰‹';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content-wrapper">
            <div class="message-header">
                <span class="message-name">${name}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="message-content">${isStreaming ? '' : formatMessage(content)}</div>
            ${role === 'assistant' && !isStreaming ? `
                <div class="message-actions">
                    <button class="message-action-btn" onclick="copyMessage(this)" title="å¤åˆ¶">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    container.appendChild(messageDiv);
    scrollToBottom();
    
    if (isStreaming) {
        return messageDiv.querySelector('.message-content');
    }
    
    return messageDiv;
}

// æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆMarkdownæ”¯æŒï¼‰
function formatMessage(content) {
    if (!content) return '';
    
    // è½¬ä¹‰HTML
    let html = escapeHtml(content);
    
    // ä»£ç å—
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        return `<div class="code-block">
            <div class="code-header">
                <span class="code-lang">${lang || 'text'}</span>
                <button class="code-copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>
            </div>
            <pre><code>${escapeHtml(code.trim())}</code></pre>
        </div>`;
    });
    
    // è¡Œå†…ä»£ç 
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ç²—ä½“
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // æ–œä½“
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // æ ‡é¢˜
    html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
    
    // åˆ—è¡¨
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // æ¢è¡Œ
    html = html.replace(/\n/g, '<br>');
    
    // éšè—å·¥å…·è°ƒç”¨æ ‡ç­¾
    html = html.replace(/<tool_call>[\s\S]*?<\/tool_call>/g, '');
    
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// å¤åˆ¶åŠŸèƒ½
function copyMessage(btn) {
    const content = btn.closest('.message-content-wrapper').querySelector('.message-content').innerText;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

function copyCode(btn) {
    const code = btn.closest('.code-block').querySelector('code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'å·²å¤åˆ¶';
        setTimeout(() => btn.textContent = 'å¤åˆ¶', 2000);
    });
}

// è¾“å…¥å¤„ç†
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

// ä¾§è¾¹æ åˆ‡æ¢
document.addEventListener('DOMContentLoaded', () => {
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
    const sidebar = document.getElementById('sidebar');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sidebar.classList.toggle('collapsed');
            
            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });
    }
    
    if (sidebarToggleMobile && sidebar) {
        sidebarToggleMobile.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sidebar.classList.toggle('mobile-open');
        });
    }
    
    // æ¢å¤ä¾§è¾¹æ çŠ¶æ€ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
    if (window.innerWidth > 768) {
        const wasCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (wasCollapsed && sidebar) {
            sidebar.classList.add('collapsed');
        }
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ç§»åŠ¨ç«¯ä¾§è¾¹æ 
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('mobile-open')) {
            if (!sidebar.contains(e.target) && !e.target.closest('.sidebar-toggle-mobile')) {
                sidebar.classList.remove('mobile-open');
            }
        }
    });
});

// æ¸…ç©ºå¯¹è¯
function clearChat() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
        document.getElementById('messagesContainer').innerHTML = `
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">ğŸ‘‹</div>
                <h3>å¯¹è¯å·²æ¸…ç©º</h3>
                <p>å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</p>
            </div>
        `;
    }
}

// å¯¼å‡ºå¯¹è¯
function exportChat() {
    const messages = [];
    document.querySelectorAll('.message').forEach(msg => {
        const role = msg.classList.contains('message-user') ? 'user' : 'assistant';
        const content = msg.querySelector('.message-content').innerText;
        messages.push({ role, content });
    });
    
    const blob = new Blob([JSON.stringify(messages, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-${workspaceId}-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('å¯¹è¯å·²å¯¼å‡º', 'success');
}

// é€šçŸ¥ç³»ç»Ÿ
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span class="notification-message">${message}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    `;
    container.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
