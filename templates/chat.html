{% extends "base.html" %}

{% block title %}{{ theme }} - AI Learning Assistant{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                å·¥ä½œåŒº
            </h3>
            <button class="sidebar-toggle" id="sidebarToggle" title="æ”¶èµ·ä¾§è¾¹æ ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/>
                </svg>
            </button>
        </div>

        <!-- ä¸Šä¸‹æ–‡æŒ‡ç¤ºå™¨ -->
        <div class="context-indicator">
            <div class="context-header">
                <span class="context-label">ä¸Šä¸‹æ–‡ä½¿ç”¨</span>
                <span class="context-value" id="contextValue">0 / 0</span>
            </div>
            <div class="context-bar">
                <div class="context-fill" id="contextFill" style="width: 0%"></div>
            </div>
            <p class="context-hint" id="contextHint">æ­£å¸¸</p>
        </div>

        <!-- å­¦ä¹ é˜¶æ®µæŒ‡ç¤º -->
        <div class="phase-indicator" id="phaseIndicator">
            <div class="phase-item active" data-phase="inquiry">
                <div class="phase-dot"></div>
                <span>éœ€æ±‚è¯¢é—®</span>
            </div>
            <div class="phase-item" data-phase="teaching">
                <div class="phase-dot"></div>
                <span>æ­£å¼æ•™å­¦</span>
            </div>
        </div>

        <!-- æ–‡ä»¶æ ‘ -->
        <div class="file-tree-container">
            <h4 class="file-tree-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                æ–‡ä»¶
            </h4>
            <div class="file-tree" id="fileTree">
                <div class="file-tree-loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å­¦ä¹ è®¡åˆ’é“¾æ¥ -->
        <div class="study-plan-link" id="studyPlanLink" style="display: none;">
            <button class="btn btn-ghost btn-sm btn-block" onclick="showStudyPlan()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                æŸ¥çœ‹å­¦ä¹ è®¡åˆ’
            </button>
        </div>
    </aside>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <main class="chat-main">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <header class="chat-header">
            <div class="chat-title">
                <button class="sidebar-toggle-mobile" id="sidebarToggleMobile">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h2 id="chatTitle">{{ theme }}</h2>
            </div>
            <div class="chat-actions">
                <button class="btn btn-ghost btn-sm" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                <button class="btn btn-ghost btn-sm" onclick="exportChat()" title="å¯¼å‡ºå¯¹è¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div class="messages-container" id="messagesContainer">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">ğŸ‘‹</div>
                <h3>å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…</h3>
                <p>AIåŠ©æ‰‹ä¼šå…ˆè¯¢é—®å‡ ä¸ªé—®é¢˜ï¼Œäº†è§£ä½ çš„å­¦ä¹ éœ€æ±‚ï¼Œç„¶åä¸ºä½ åˆ¶å®šä¸“å±å­¦ä¹ è®¡åˆ’ã€‚</p>
            </div>
            <!-- æ¶ˆæ¯å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>

        <!-- å·¥å…·çŠ¶æ€æ  -->
        <div class="tool-status-bar" id="toolStatusBar" style="display: none;">
            <div class="tool-status-item">
                <span class="tool-status-spinner"></span>
                <span class="tool-status-text" id="toolStatusText">å¤„ç†ä¸­...</span>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea
                    id="messageInput"
                    class="message-input"
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    rows="1"
                    onkeypress="handleKeyPress(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
            <p class="input-hint">æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</p>

            <!-- ç”Ÿæˆå­¦ä¹ è®¡åˆ’æŒ‰é’®ï¼ˆå¤‡ç”¨é€‰é¡¹ï¼‰ -->
            <div class="generate-plan-container" id="generatePlanContainer" style="display: none;">
                <button class="btn btn-secondary btn-block" onclick="generateStudyPlan()" id="generatePlanBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    æ‰‹åŠ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’
                </button>
                <p class="plan-hint">å¦‚æœAIæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼Œå¯ä»¥ç‚¹å‡»æ­¤æŒ‰é’®æ‰‹åŠ¨è§¦å‘</p>
            </div>
        </div>
    </main>

    <!-- å³ä¾§é¢˜ç›®æ  -->
    <aside class="exercise-sidebar" id="exerciseSidebar">
        <div class="exercise-sidebar-header">
            <h3 class="exercise-sidebar-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                ç»ƒä¹ é¢˜
            </h3>
            <button class="exercise-sidebar-toggle" id="exerciseSidebarToggle" title="æ”¶èµ·é¢˜ç›®æ ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/>
                </svg>
            </button>
        </div>

        <div class="exercise-list" id="exerciseList">
            <div class="exercise-list-empty">
                <div class="empty-icon">ğŸ“</div>
                <p>æš‚æ— ç»ƒä¹ é¢˜</p>
                <p class="empty-hint">AIä¼šåœ¨æ•™å­¦è¿‡ç¨‹ä¸­ç”Ÿæˆç»ƒä¹ é¢˜</p>
            </div>
        </div>
    </aside>
</div>

<!-- å­¦ä¹ è®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal modal-large" id="studyPlanModal">
    <div class="modal-overlay" onclick="hideStudyPlan()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>å­¦ä¹ è®¡åˆ’</h3>
            <button class="modal-close" onclick="hideStudyPlan()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="markdown-content" id="studyPlanContent">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
</div>

<!-- ç»ƒä¹ é¢˜æ¨¡æ€æ¡† -->
<div class="modal" id="exerciseModal">
    <div class="modal-overlay" onclick="hideExercise()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç»ƒä¹ é¢˜</h3>
            <span class="exercise-difficulty" id="exerciseDifficulty">ä¸­ç­‰</span>
            <button class="modal-close" onclick="hideExercise()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="exercise-content" id="exerciseContent">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="exercise-result" id="exerciseResult" style="display: none;">
                <!-- ç­”é¢˜ç»“æœ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideExercise()">å…³é—­</button>
            <button class="btn btn-primary" id="submitExerciseBtn" onclick="submitExercise()">æäº¤ç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal modal-large" id="filePreviewModal">
    <div class="modal-overlay" onclick="hideFilePreview()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="filePreviewTitle">æ–‡ä»¶é¢„è§ˆ</h3>
            <button class="modal-close" onclick="hideFilePreview()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <pre class="file-preview-content" id="filePreviewContent"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€çŠ¶æ€
const workspaceId = '{{ workspace_id }}';
let currentPhase = 'inquiry';
let inquiryHistory = [];
let isGenerating = false;
let currentExercise = null;
let tokenCount = 0;
let tokenThreshold = 0;
let exercises = []; // å­˜å‚¨ç»ƒä¹ é¢˜åˆ—è¡¨

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadWorkspaceData();
    loadFileTree();
    initExerciseSidebar();
});

// åŠ è½½å·¥ä½œåŒºæ•°æ®
async function loadWorkspaceData() {
    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/messages`);
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            currentPhase = data.phase;
            tokenCount = data.token_count;
            tokenThreshold = data.token_threshold;
            
            updateContextIndicator();
            updatePhaseIndicator();
            
            // å¦‚æœæœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå®ƒä»¬å¹¶åˆå§‹åŒ–inquiryHistory
            if (data.messages && data.messages.length > 0) {
                document.getElementById('welcomeMessage').style.display = 'none';
                data.messages.forEach(msg => {
                    if (msg.role !== 'system') {
                        appendMessage(msg.role, msg.content);
                        // æ·»åŠ åˆ°inquiryHistoryï¼ˆç”¨äºç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼‰
                        if (currentPhase === 'inquiry' || currentPhase === 'init') {
                            inquiryHistory.push({ role: msg.role, content: msg.content });
                        }
                    }
                });
            }
            
            // æ ¹æ®é˜¶æ®µæ˜¾ç¤ºç›¸åº”å†…å®¹
            if (currentPhase === 'teaching') {
                // æ•™å­¦é˜¶æ®µï¼šæ˜¾ç¤ºå­¦ä¹ è®¡åˆ’é“¾æ¥
                document.getElementById('studyPlanLink').style.display = 'block';
                document.getElementById('welcomeMessage').style.display = 'none';
            } else if (currentPhase === 'init' || currentPhase === 'inquiry') {
                // åˆå§‹åŒ–æˆ–è¯¢é—®é˜¶æ®µï¼šå¼€å§‹è¯¢é—®
                startInquiry();
            }
        }
    } catch (error) {
        console.error('åŠ è½½å·¥ä½œåŒºæ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°ä¸Šä¸‹æ–‡æŒ‡ç¤ºå™¨
function updateContextIndicator() {
    const percentage = tokenThreshold > 0 ? (tokenCount / tokenThreshold * 100) : 0;
    const contextValue = document.getElementById('contextValue');
    const contextFill = document.getElementById('contextFill');
    const contextHint = document.getElementById('contextHint');
    
    const maxContext = Math.round(tokenThreshold / 0.8 / 1000);
    contextValue.textContent = `${Math.round(tokenCount / 1000)}K / ${maxContext}K`;
    contextFill.style.width = `${Math.min(percentage, 100)}%`;
    
    if (percentage < 50) {
        contextFill.className = 'context-fill';
        contextHint.textContent = 'æ­£å¸¸';
        contextHint.className = 'context-hint';
    } else if (percentage < 80) {
        contextFill.className = 'context-fill warning';
        contextHint.textContent = 'æ¥è¿‘é˜ˆå€¼';
        contextHint.className = 'context-hint warning';
    } else {
        contextFill.className = 'context-fill danger';
        contextHint.textContent = 'å·²å‹ç¼©';
        contextHint.className = 'context-hint danger';
    }
}

// åˆå§‹åŒ–å³ä¾§é¢˜ç›®æ 
function initExerciseSidebar() {
    const sidebarToggle = document.getElementById('exerciseSidebarToggle');
    const sidebar = document.getElementById('exerciseSidebar');

    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            sidebarToggle.querySelector('svg').style.transform =
                sidebar.classList.contains('collapsed') ? 'rotate(180deg)' : 'rotate(0)';
        });
    }

    // ç§»åŠ¨ç«¯åˆ‡æ¢æŒ‰é’®
    const mobileToggle = document.createElement('button');
    mobileToggle.className = 'sidebar-toggle-mobile exercise-toggle-mobile';
    mobileToggle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
    `;
    mobileToggle.title = 'æ‰“å¼€é¢˜ç›®æ ';
    mobileToggle.onclick = () => sidebar.classList.toggle('mobile-open');

    const chatTitle = document.querySelector('.chat-title');
    if (chatTitle) {
        chatTitle.appendChild(mobileToggle);
    }
}

// æ·»åŠ ç»ƒä¹ é¢˜åˆ°å³ä¾§æ 
function addExerciseToSidebar(exercise) {
    // ç”Ÿæˆå”¯ä¸€ID
    exercise.id = `ex_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    exercise.createdAt = new Date().toISOString();

    // æ·»åŠ åˆ°åˆ—è¡¨
    exercises.unshift(exercise);

    // æ›´æ–°æ˜¾ç¤º
    updateExerciseList();

    return exercise.id;
}

// æ›´æ–°ç»ƒä¹ é¢˜åˆ—è¡¨æ˜¾ç¤º
function updateExerciseList() {
    const exerciseList = document.getElementById('exerciseList');
    if (!exerciseList) return;

    if (exercises.length === 0) {
        exerciseList.innerHTML = `
            <div class="exercise-list-empty">
                <div class="empty-icon">ğŸ“</div>
                <p>æš‚æ— ç»ƒä¹ é¢˜</p>
                <p class="empty-hint">AIä¼šåœ¨æ•™å­¦è¿‡ç¨‹ä¸­ç”Ÿæˆç»ƒä¹ é¢˜</p>
            </div>
        `;
        return;
    }

    let html = '';
    exercises.forEach((exercise, index) => {
        const typeText = {
            'choice': 'é€‰æ‹©é¢˜',
            'fill_blank': 'å¡«ç©ºé¢˜',
            'short_answer': 'ç®€ç­”é¢˜',
            'match': 'åŒ¹é…é¢˜',
            'multi_fill': 'å¤šç©ºé¢˜'
        }[exercise.type] || 'ç»ƒä¹ é¢˜';

        const difficultyText = {
            'easy': 'ç®€å•',
            'medium': 'ä¸­ç­‰',
            'hard': 'å›°éš¾'
        }[exercise.difficulty] || 'ä¸­ç­‰';

        // æˆªå–é—®é¢˜é¢„è§ˆ
        const questionPreview = exercise.question.length > 100
            ? exercise.question.substring(0, 100) + '...'
            : exercise.question;

        html += `
            <div class="exercise-item" data-exercise-id="${exercise.id}">
                <div class="exercise-item-header">
                    <span class="exercise-item-type">${typeText}</span>
                    <span class="exercise-item-difficulty ${exercise.difficulty}">${difficultyText}</span>
                </div>
                <div class="exercise-item-question">${escapeHtml(questionPreview)}</div>
                <div class="exercise-item-actions">
                    <button class="exercise-item-btn" onclick="viewExercise('${exercise.id}')">æŸ¥çœ‹</button>
                    <button class="exercise-item-btn primary" onclick="startExercise('${exercise.id}')">å¼€å§‹ç­”é¢˜</button>
                </div>
            </div>
        `;
    });

    exerciseList.innerHTML = html;
}

// æŸ¥çœ‹ç»ƒä¹ é¢˜è¯¦æƒ…
function viewExercise(exerciseId) {
    const exercise = exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;

    // æ˜¾ç¤ºç»ƒä¹ é¢˜æ¨¡æ€æ¡†
    showExercise(exercise);
}

// å¼€å§‹ç­”é¢˜
function startExercise(exerciseId) {
    const exercise = exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;

    currentExercise = exercise;
    showExercise(exercise);
}

// æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
function updatePhaseIndicator() {
    const items = document.querySelectorAll('.phase-item');
    items.forEach(item => {
        const phase = item.dataset.phase;
        if (phase === currentPhase) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    // æ›´æ–°ç”Ÿæˆå­¦ä¹ è®¡åˆ’æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
    const generatePlanContainer = document.getElementById('generatePlanContainer');
    // åªåœ¨è¯¢é—®é˜¶æ®µå¼€å§‹æ—¶æ˜¾ç¤ºï¼Œå½“AIå¼€å§‹è¯¢é—®åå°±éšè—
    if (currentPhase === 'inquiry' && inquiryHistory.length === 0) {
        generatePlanContainer.style.display = 'block';
    } else {
        generatePlanContainer.style.display = 'none';
    }
}

// å¼€å§‹è¯¢é—®é˜¶æ®µ
function startInquiry() {
    currentPhase = 'inquiry';
    updatePhaseIndicator();

    // åªæœ‰åœ¨æ²¡æœ‰å†å²æ¶ˆæ¯æ—¶æ‰å‘é€åˆå§‹æ¶ˆæ¯
    if (inquiryHistory.length === 0) {
        const welcomeMsg = `ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå­¦ä¹ åŠ©æ‰‹ã€‚ä½ æƒ³å­¦ä¹ "{{ theme }}"ï¼Œè¿™æ˜¯ä¸ªå¾ˆæ£’çš„é€‰æ‹©ï¼

ä¸ºäº†ç»™ä½ åˆ¶å®šæœ€åˆé€‚çš„å­¦ä¹ è®¡åˆ’ï¼Œæˆ‘æƒ³å…ˆäº†è§£å‡ ä¸ªæƒ…å†µï¼š

1. **ä½ çš„å­¦ä¹ ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ** æ˜¯æƒ³å…¥é—¨äº†è§£ã€ç³»ç»Ÿå­¦ä¹ ï¼Œè¿˜æ˜¯è§£å†³æŸä¸ªå…·ä½“é—®é¢˜ï¼Ÿ

è¯·éšæ„å›ç­”ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„æƒ…å†µç»§ç»­æé—®ã€‚`;

        setTimeout(() => {
            appendMessage('assistant', welcomeMsg);
            inquiryHistory.push({ role: 'assistant', content: welcomeMsg });
        }, 500);
    }
}

// å‘é€æ¶ˆæ¯
async function sendMessage(message = null, autoStart = false) {
    if (isGenerating) return;

    const input = document.getElementById('messageInput');
    let userMessage = message !== null ? message : input.value.trim();

    // åœ¨æ•™å­¦é˜¶æ®µï¼Œå…è®¸ç©ºæ¶ˆæ¯ä½œä¸º"ç»§ç»­"çš„ç¡®è®¤
    // å¦‚æœæœ‰ pendingToolResultï¼ˆå¦‚ç»ƒä¹ åé¦ˆï¼‰ï¼Œç©ºæ¶ˆæ¯è¡¨ç¤º"ç»§ç»­"
    const hasToolResult = window.pendingToolResult !== null && window.pendingToolResult !== undefined;
    if (currentPhase === 'teaching' && !userMessage && !autoStart && !hasToolResult) {
        userMessage = "è¯·ç»§ç»­"; // é»˜è®¤çš„ç»§ç»­æ¶ˆæ¯
    }

    // å…è®¸å‘é€ç©ºæ¶ˆæ¯ï¼ˆå½“æœ‰å¾…å¤„ç†çš„å·¥å…·ç»“æœæ—¶ï¼‰
    if (!userMessage && !autoStart && !hasToolResult) return;

    if (!autoStart) {
        input.value = '';
        autoResize(input);
        // åªæœ‰å½“æœ‰æ¶ˆæ¯å†…å®¹æ—¶æ‰æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
        // ï¼ˆç­”é¢˜åçš„ç©º"ç»§ç»­"æ¶ˆæ¯ä¸æ˜¾ç¤ºï¼‰
        if (userMessage) {
            appendMessage('user', userMessage);
        }
    }

    if (currentPhase === 'inquiry') {
        // æ€»æ˜¯å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²ï¼Œå³ä½¿æ˜¯ç©ºæ¶ˆæ¯ï¼ˆç”¨äºè§¦å‘AIå¼€å§‹æ•™å­¦ï¼‰
        if (userMessage || autoStart) {
            inquiryHistory.push({ role: 'user', content: userMessage });
        }
        await sendInquiryMessage(userMessage);
    } else {
        await sendTeachingMessage(userMessage);
    }
}

// å‘é€è¯¢é—®é˜¶æ®µæ¶ˆæ¯
async function sendInquiryMessage(message) {
    isGenerating = true;
    showToolStatus('AIæ­£åœ¨æ€è€ƒ...', true);

    // å¦‚æœAIè°ƒç”¨äº†end_inquiryå·¥å…·ï¼Œåˆ™ä¸åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆé¿å…ç©ºæ¶ˆæ¯ï¼‰
    let responseDiv = null;
    let hasContentStarted = false;
    let fullResponse = '';
    let inquiryComplete = false;
    let endInquiryCalled = false;

    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/inquiry`);
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: inquiryHistory
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6);
                    if (dataStr === '[DONE]') continue;

                    try {
                        const data = JSON.parse(dataStr);

                        if (data.error) {
                            if (responseDiv) {
                                responseDiv.innerHTML = `<span class="error">é”™è¯¯: ${data.error}</span>`;
                            } else {
                                responseDiv = appendMessage('assistant', `<span class="error">é”™è¯¯: ${data.error}</span>`, false);
                            }
                            isGenerating = false;
                            showToolStatus('', false);
                            return;
                        }

                        // å¤„ç†å†…å®¹ - å»¶è¿Ÿåˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼Œç›´åˆ°ç¡®å®æœ‰å†…å®¹
                        if (data.content && data.content.trim()) {
                            if (!hasContentStarted) {
                                // ç¬¬ä¸€æ¬¡æœ‰å†…å®¹æ—¶åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                                responseDiv = appendMessage('assistant', '', true);
                                hasContentStarted = true;
                            }
                            fullResponse += data.content;
                            if (responseDiv) {
                                responseDiv.innerHTML = formatMessage(fullResponse);
                            }
                            // åªåœ¨æ¶ˆæ¯å¼€å§‹æ—¶æ»šåŠ¨ä¸€æ¬¡
                            if (fullResponse.length <= data.content.length) {
                                scrollToBottom();
                            }
                        }

                        // å¤„ç†å·¥å…·è°ƒç”¨
                        if (data.tool_call) {
                            const toolName = data.tool_call.name;
                            const status = data.tool_call.status;
                            const result = data.tool_call.result;

                            if (toolName === 'end_inquiry') {
                                // æ ‡è®°end_inquiryå·²è¢«è°ƒç”¨
                                endInquiryCalled = true;
                                // å¯¹äºend_inquiryå·¥å…·ï¼Œåªæ›´æ–°çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå·¥å…·è°ƒç”¨æ¶ˆæ¯
                                // çœŸæ­£çš„å®Œæˆä¿¡å·ä¼šåœ¨data.inquiry_completeä¸­å¤„ç†
                                showToolStatus('AIå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯ï¼Œæ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...', true);
                                inquiryComplete = true;
                            } else {
                                showToolCallInChat(toolName, status, result);
                            }
                        }

                        // å¤„ç†è¯¢é—®å®Œæˆä¿¡å·
                        if (data.inquiry_complete) {
                            console.log('æ”¶åˆ°inquiry_completeä¿¡å·ï¼Œsummary:', data.summary);
                            inquiryComplete = true;
                            endInquiryCalled = true;
                            showNotification('AIå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯ï¼Œæ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...', 'success');
                            // åªåœ¨è¿™é‡Œæ˜¾ç¤ºä¸€æ¬¡å·¥å…·è°ƒç”¨å®Œæˆæ¶ˆæ¯
                            showToolCallInChat('end_inquiry', 'inquiry_complete', {summary: data.summary || 'AIå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯'});
                        }

                        if (data.done) {
                            console.log('æ”¶åˆ°doneä¿¡å·ï¼ŒinquiryComplete:', inquiryComplete, 'fullResponseé•¿åº¦:', fullResponse.length, 'endInquiryCalled:', endInquiryCalled);

                            // åªæœ‰å½“æœ‰å®é™…å†…å®¹æ—¶æ‰æ·»åŠ åˆ°å†å²
                            if (fullResponse.trim()) {
                                inquiryHistory.push({ role: 'assistant', content: fullResponse });
                            }

                            // å¦‚æœè¯¢é—®å®Œæˆï¼Œè‡ªåŠ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’
                            if (inquiryComplete) {
                                console.log('è¯¢é—®å®Œæˆï¼Œè‡ªåŠ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...');
                                // å¦‚æœend_inquiryè¢«è°ƒç”¨ä¸”æ²¡æœ‰å†…å®¹ï¼Œç§»é™¤ç©ºæ¶ˆæ¯å®¹å™¨
                                if (endInquiryCalled && responseDiv && !fullResponse.trim()) {
                                    responseDiv.remove();
                                    console.log('end_inquiryè°ƒç”¨ä¸”æ— å†…å®¹ï¼Œå·²ç§»é™¤ç©ºæ¶ˆæ¯å®¹å™¨');
                                }
                                setTimeout(() => {
                                    generateStudyPlan();
                                }, 1000);
                            }
                        }
                    } catch (e) {
                        console.error('è§£æé”™è¯¯:', e);
                    }
                }
            }
        }
    } catch (error) {
        if (responseDiv) {
            responseDiv.innerHTML = `<span class="error">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`;
        } else {
            appendMessage('assistant', `<span class="error">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`, false);
        }
        console.error(error);
    } finally {
        isGenerating = false;
        showToolStatus('', false);
    }
}

// åˆ¤æ–­æ˜¯å¦ç»“æŸè¯¢é—®
function shouldEndInquiry(response) {
    const indicators = [
        'å‡†å¤‡åˆ¶å®šå­¦ä¹ è®¡åˆ’',
        'å¯ä»¥å¼€å§‹åˆ¶å®šè®¡åˆ’',
        'å·²ç»äº†è§£è¶³å¤Ÿ',
        'è®©æˆ‘ä¸ºä½ åˆ¶å®š',
        'ready to create',
        'create a study plan'
    ];
    
    const lowerResponse = response.toLowerCase();
    return indicators.some(ind => lowerResponse.includes(ind.toLowerCase()));
}

// ç”Ÿæˆå­¦ä¹ è®¡åˆ’
async function generateStudyPlan() {
    console.log('å¼€å§‹ç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼ŒinquiryHistoryé•¿åº¦:', inquiryHistory.length);
    showToolStatus('æ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...', true);

    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/plan`);
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: inquiryHistory })
        });

        console.log('å­¦ä¹ è®¡åˆ’APIå“åº”çŠ¶æ€:', response.status);
        const data = await response.json();
        console.log('å­¦ä¹ è®¡åˆ’APIå“åº”æ•°æ®:', data);

        if (data.success) {
            console.log('å­¦ä¹ è®¡åˆ’ç”ŸæˆæˆåŠŸï¼Œæ›´æ–°é˜¶æ®µä¸ºteaching');
            currentPhase = 'teaching';
            updatePhaseIndicator();

            // ä¸å†æ˜¾ç¤ºé¢„è®¾æ¶ˆæ¯ï¼Œè®©AIç”Ÿæˆç¬¬ä¸€å¥è¯
            document.getElementById('studyPlanLink').style.display = 'block';

            showNotification('å­¦ä¹ è®¡åˆ’å·²ç”Ÿæˆï¼ŒAIå°†å¼€å§‹æ•™å­¦', 'success');

            // è‡ªåŠ¨å‘é€ä¸€æ¡ç©ºæ¶ˆæ¯ï¼Œè®©AIå¼€å§‹æ•™å­¦
            setTimeout(() => {
                console.log('è‡ªåŠ¨å‘é€ç©ºæ¶ˆæ¯å¼€å§‹æ•™å­¦');
                sendMessage('', true); // å‘é€ç©ºæ¶ˆæ¯è§¦å‘AIå¼€å§‹æ•™å­¦
            }, 500);
        } else {
            console.error('å­¦ä¹ è®¡åˆ’ç”Ÿæˆå¤±è´¥:', data.error);
            showNotification(data.error || 'ç”Ÿæˆå¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ç½‘ç»œé”™è¯¯', 'error');
        console.error(error);
    } finally {
        showToolStatus('', false);
    }
}

// å‘é€æ•™å­¦é˜¶æ®µæ¶ˆæ¯
async function sendTeachingMessage(message) {
    isGenerating = true;
    showToolStatus('AIæ­£åœ¨æ€è€ƒ...', true);
    
    const responseDiv = appendMessage('assistant', '', true);
    let fullResponse = '';
    let hasExercise = false;
    
    // å¦‚æœæœ‰å¾…å‘é€çš„å·¥å…·ç»“æœï¼ˆå¦‚ç»ƒä¹ åé¦ˆï¼‰ï¼ŒåŒ…å«åœ¨è¯·æ±‚ä¸­
    const toolResult = window.pendingToolResult || null;
    if (toolResult) {
        window.pendingToolResult = null; // ä½¿ç”¨åæ¸…ç©º
    }
    
    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/chat`);
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                tool_result: toolResult
            })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6);
                    if (dataStr === '[DONE]') continue;
                    
                    try {
                        const data = JSON.parse(dataStr);
                        
                        if (data.error) {
                            responseDiv.innerHTML = `<span class="error">é”™è¯¯: ${data.error}</span>`;
                            isGenerating = false;
                            showToolStatus('', false);
                            return;
                        }
                        
                        if (data.content) {
                            fullResponse += data.content;
                            responseDiv.innerHTML = formatMessage(fullResponse);
                            // åªåœ¨æ¶ˆæ¯å¼€å§‹æ—¶æ»šåŠ¨ä¸€æ¬¡
                            if (fullResponse.length <= data.content.length) {
                                scrollToBottom();
                            }
                        }
                        
                        if (data.tool_call) {
                            const toolName = data.tool_call.name;
                            const status = data.tool_call.status;
                            const result = data.tool_call.result;

                            showToolStatus(`æ­£åœ¨${getToolName(toolName)}...`, true);
                            showToolCallInChat(toolName, status, result);
                        }
                        
                        if (data.status === 'context_compressed') {
                            showNotification('ä¸Šä¸‹æ–‡å·²è‡ªåŠ¨å‹ç¼©', 'info');
                            updateContextIndicator();
                        }
                        
                        if (data.done) {
                            tokenCount = data.token_count || tokenCount;
                            updateContextIndicator();
                            
                            // AIå›å¤å®Œæˆåï¼Œå¦‚æœæœ‰å¾…æ˜¾ç¤ºçš„é¢˜ç›®ï¼Œåˆ™æ˜¾ç¤º
                            if (window.pendingExercise) {
                                setTimeout(() => {
                                    showExercise(window.pendingExercise);
                                    window.pendingExercise = null;
                                }, 300);
                            }
                        }

                        // å¤„ç†ç»ƒä¹ é¢˜æ•°æ® - å»¶è¿Ÿåˆ°AIå›å¤å®Œæˆåæ˜¾ç¤º
                        if (data.exercise && !hasExercise) {
                            hasExercise = true;
                            // ä¿å­˜ç»ƒä¹ é¢˜æ•°æ®ï¼Œåœ¨doneæ—¶æ˜¾ç¤º
                            window.pendingExercise = data.exercise;
                        }
                    } catch (e) {
                        console.error('è§£æé”™è¯¯:', e);
                    }
                }
            }
        }
    } catch (error) {
        responseDiv.innerHTML = `<span class="error">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`;
        console.error(error);
    } finally {
        isGenerating = false;
        showToolStatus('', false);
    }
}

// è·å–å·¥å…·åç§°
function getToolName(name) {
    const names = {
        'generate_exercise': 'ç”Ÿæˆç»ƒä¹ é¢˜',
        'web_search': 'æœç´¢ç½‘ç»œ',
        'file_system': 'æ“ä½œæ–‡ä»¶',
        'wait_user_answer': 'ç­‰å¾…ç”¨æˆ·è¾“å…¥'
    };
    return names[name] || name;
}

// æ˜¾ç¤ºå·¥å…·çŠ¶æ€
function showToolStatus(text, show) {
    const bar = document.getElementById('toolStatusBar');
    const statusText = document.getElementById('toolStatusText');

    if (show && text) {
        statusText.textContent = text;
        bar.style.display = 'flex';
    } else {
        bar.style.display = 'none';
    }
}

// åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯
function showToolCallInChat(toolName, status, result = null) {
    const container = document.getElementById('messagesContainer');
    const toolDiv = document.createElement('div');
    toolDiv.className = 'message message-tool';

    let statusText = '';
    let statusClass = '';

    switch(status) {
        case 'started':
            statusText = `æ­£åœ¨${getToolName(toolName)}...`;
            statusClass = 'tool-status-started';
            break;
        case 'completed':
            statusText = `${getToolName(toolName)}å®Œæˆ`;
            statusClass = 'tool-status-completed';
            break;
        case 'error':
            statusText = `${getToolName(toolName)}å¤±è´¥`;
            statusClass = 'tool-status-error';
            break;
        case 'inquiry_complete':
            statusText = 'AIå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯ï¼Œæ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’...';
            statusClass = 'tool-status-inquiry-complete';
            break;
        default:
            statusText = `${getToolName(toolName)}: ${status}`;
            statusClass = 'tool-status-other';
    }

    let resultHtml = '';
    if (result) {
        if (result.error) {
            resultHtml = `<div class="tool-error">é”™è¯¯: ${escapeHtml(result.error)}</div>`;
            if (result.hint) {
                resultHtml += `<div class="tool-hint">æç¤º: ${escapeHtml(result.hint)}</div>`;
            }
        } else if (result.success) {
            resultHtml = `<div class="tool-success">æˆåŠŸ: ${escapeHtml(result.message || 'æ“ä½œå®Œæˆ')}</div>`;
            // æ–‡ä»¶æ“ä½œæˆåŠŸååˆ·æ–°ä¾§è¾¹æ æ–‡ä»¶æ ‘
            if (toolName === 'file_system') {
                setTimeout(() => loadFileTree(), 500);
            }
        }
    }

    toolDiv.innerHTML = `
        <div class="message-card">
            <div class="message-header">
                <span class="message-sender">å·¥å…·è°ƒç”¨</span>
                <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            <div class="message-content">
                <div class="tool-call-info ${statusClass}">
                    <span class="tool-name">${getToolName(toolName)}</span>
                    <span class="tool-status">${statusText}</span>
                </div>
                ${resultHtml}
            </div>
        </div>
    `;

    container.appendChild(toolDiv);
    scrollToBottom();
}


// æ˜¾ç¤ºç»ƒä¹ é¢˜
function showExercise(exercise) {
    // ç¡®ä¿currentExerciseè¢«æ­£ç¡®è®¾ç½®ï¼Œè¿™æ˜¯æäº¤ç­”æ¡ˆçš„å…³é”®
    currentExercise = exercise;
    
    // å¦‚æœç»ƒä¹ é¢˜è¿˜æ²¡æœ‰IDï¼Œæ·»åŠ åˆ°å³ä¾§æ 
    if (!exercise.id) {
        addExerciseToSidebar(exercise);
    }

    const modal = document.getElementById('exerciseModal');
    const content = document.getElementById('exerciseContent');
    const difficulty = document.getElementById('exerciseDifficulty');
    const result = document.getElementById('exerciseResult');

    difficulty.textContent = exercise.difficulty === 'easy' ? 'ç®€å•' :
                             exercise.difficulty === 'hard' ? 'å›°éš¾' : 'ä¸­ç­‰';
    difficulty.className = `exercise-difficulty ${exercise.difficulty}`;
    result.style.display = 'none';
    
    let html = `<div class="exercise-question">${formatMessage(exercise.question)}</div>`;
    
    if (exercise.type === 'choice' && exercise.options) {
        html += '<div class="exercise-options">';
        exercise.options.forEach((opt, idx) => {
            html += `
                <label class="exercise-option">
                    <input type="radio" name="exercise_answer" value="${idx}">
                    <span>${escapeHtml(opt)}</span>
                </label>
            `;
        });
        html += '</div>';
    } else if (exercise.type === 'fill_blank' && exercise.blanks) {
        html += '<div class="exercise-blanks">';
        exercise.blanks.forEach((blank, idx) => {
            html += `
                <div class="exercise-blank">
                    <label>å¡«ç©º ${idx + 1}:</label>
                    <input type="text" class="form-input blank-input" data-index="${idx}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                </div>
            `;
        });
        html += '</div>';
    } else {
        html += `
            <div class="exercise-answer-area">
                <textarea class="form-input" id="exerciseAnswer" rows="4" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ"></textarea>
            </div>
        `;
    }
    
    content.innerHTML = html;
    modal.classList.add('active');
}

// æäº¤ç»ƒä¹ é¢˜ç­”æ¡ˆ
async function submitExercise() {
    if (!currentExercise) return;
    
    let answers = [];
    let answerText = '';
    
    if (currentExercise.type === 'choice') {
        const selected = document.querySelector('input[name="exercise_answer"]:checked');
        if (!selected) {
            showNotification('è¯·é€‰æ‹©ç­”æ¡ˆ', 'warning');
            return;
        }
        answers = [selected.value];
        const selectedIndex = parseInt(selected.value);
        answerText = currentExercise.options[selectedIndex];
    } else if (currentExercise.type === 'fill_blank') {
        const inputs = document.querySelectorAll('.blank-input');
        inputs.forEach(input => {
            answers.push(input.value.trim());
        });
        answerText = answers.join(', ');
    } else {
        const answer = document.getElementById('exerciseAnswer').value.trim();
        if (!answer) {
            showNotification('è¯·è¾“å…¥ç­”æ¡ˆ', 'warning');
            return;
        }
        answers = [answer];
        answerText = answer;
    }
    
    // å®¢è§‚é¢˜ç›´æ¥éªŒè¯
    if (['choice', 'fill_blank', 'match', 'multi_fill'].includes(currentExercise.type)) {
        let isCorrect = false;
        
        if (currentExercise.type === 'choice') {
            // é€‰æ‹©é¢˜ï¼šå°†ç´¢å¼•è½¬æ¢ä¸ºå¯¹åº”é€‰é¡¹æ–‡æœ¬å†æ¯”è¾ƒ
            const selectedIndex = parseInt(answers[0]);
            const selectedText = currentExercise.options[selectedIndex];
            isCorrect = currentExercise.correct_answers.includes(selectedText);
        } else {
            // å…¶ä»–é¢˜å‹ç›´æ¥æ¯”è¾ƒ
            isCorrect = JSON.stringify(answers) === JSON.stringify(currentExercise.correct_answers);
        }
        
        showExerciseResult(isCorrect, currentExercise.explanation);
        
        // æ„é€ å·¥å…·ç»“æœæ ¼å¼ï¼Œç”¨äºä¼ é€’ç»™ wait_user_answer
        window.pendingToolResult = {
            event: 'exercise_submitted',
            exercise_id: currentExercise.id || currentExercise.exercise_id,
            question: currentExercise.question,
            user_answer: answerText,
            correct_answers: currentExercise.correct_answers,
            is_correct: isCorrect,
            explanation: currentExercise.explanation
        };
        
        // æ˜¾ç¤ºæç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·å¯ä»¥ç‚¹å‡»å‘é€æŒ‰é’®ç»§ç»­
        showNotification(`å›ç­”${isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯'}ï¼ç‚¹å‡»å‘é€æŒ‰é’®ç»§ç»­å­¦ä¹ `, 'success');
        
        // 3ç§’åè‡ªåŠ¨å…³é—­æ¨¡æ€æ¡†
        setTimeout(() => {
            hideExercise();
        }, 3000);
    } else {
        // ä¸»è§‚é¢˜éœ€è¦AIæ‰¹æ”¹
        showNotification('ä¸»è§‚é¢˜éœ€è¦AIæ‰¹æ”¹ï¼ŒåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
}

// æ˜¾ç¤ºç»ƒä¹ ç»“æœ
function showExerciseResult(correct, explanation) {
    const result = document.getElementById('exerciseResult');
    result.innerHTML = `
        <div class="result-status ${correct ? 'correct' : 'incorrect'}">
            <span class="result-icon">${correct ? 'âœ“' : 'âœ—'}</span>
            <span class="result-text">${correct ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}</span>
        </div>
        <div class="result-explanation">
            <strong>è§£æï¼š</strong>
            <p>${formatMessage(explanation)}</p>
        </div>
    `;
    result.style.display = 'block';
}

function hideExercise() {
    document.getElementById('exerciseModal').classList.remove('active');
    currentExercise = null;
}

// åŠ è½½æ–‡ä»¶æ ‘
async function loadFileTree() {
    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/files`);
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            renderFileTree(data.files);
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
    }
}

// æ¸²æŸ“æ–‡ä»¶æ ‘
function renderFileTree(files) {
    const container = document.getElementById('fileTree');
    
    if (files.length === 0) {
        container.innerHTML = '<div class="file-tree-empty">æš‚æ— æ–‡ä»¶</div>';
        return;
    }
    
    const grouped = groupFilesByDir(files);
    container.innerHTML = renderFileGroup(grouped, 0);
}

function groupFilesByDir(files) {
    const root = { name: '', children: {}, files: [] };
    
    files.forEach(file => {
        const parts = file.path.split('/');
        let current = root;
        
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!current.children[part]) {
                current.children[part] = { name: part, children: {}, files: [] };
            }
            current = current.children[part];
        }
        
        current.files.push(file);
    });
    
    return root;
}

function renderFileGroup(group, level) {
    let html = '';
    
    // æ¸²æŸ“å­ç›®å½•
    for (const [name, child] of Object.entries(group.children)) {
        html += `
            <div class="file-tree-folder" style="padding-left: ${level * 12}px">
                <div class="file-tree-folder-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>${escapeHtml(name)}</span>
                </div>
                <div class="file-tree-folder-content">
                    ${renderFileGroup(child, level + 1)}
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“æ–‡ä»¶
    for (const file of group.files) {
        const fileName = file.name;
        html += `
            <div class="file-tree-item" style="padding-left: ${level * 12 + 20}px" 
                 onclick="previewFile('${file.path}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>${escapeHtml(fileName)}</span>
            </div>
        `;
    }
    
    return html;
}

// é¢„è§ˆæ–‡ä»¶
async function previewFile(filePath) {
    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/files/${encodeURIComponent(filePath)}`);
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('filePreviewTitle').textContent = filePath;
            document.getElementById('filePreviewContent').textContent = data.content;
            document.getElementById('filePreviewModal').classList.add('active');
        } else {
            showNotification(data.error || 'åŠ è½½å¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ç½‘ç»œé”™è¯¯', 'error');
        console.error(error);
    }
}

function hideFilePreview() {
    document.getElementById('filePreviewModal').classList.remove('active');
}

// æ˜¾ç¤ºå­¦ä¹ è®¡åˆ’
async function showStudyPlan() {
    try {
        const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/files/study_plan.md`);
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('studyPlanContent').innerHTML = formatMessage(data.content);
            document.getElementById('studyPlanModal').classList.add('active');
        } else {
            showNotification('å­¦ä¹ è®¡åˆ’å°šæœªç”Ÿæˆ', 'warning');
        }
    } catch (error) {
        showNotification('åŠ è½½å¤±è´¥', 'error');
        console.error(error);
    }
}

function hideStudyPlan() {
    document.getElementById('studyPlanModal').classList.remove('active');
}

// æ¶ˆæ¯å¤„ç†
function appendMessage(role, content, isStreaming = false) {
    const container = document.getElementById('messagesContainer');
    const welcomeMsg = document.getElementById('welcomeMessage');

    if (welcomeMsg) {
        welcomeMsg.style.display = 'none';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;

    const name = role === 'user' ? 'ä½ ' : 'AIåŠ©æ‰‹';
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = `
        <div class="message-card">
            <div class="message-header">
                <span class="message-sender">${name}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-content">${isStreaming ? '' : formatMessage(content)}</div>
            ${role === 'assistant' && !isStreaming ? `
                <div class="message-actions">
                    <button class="message-action-btn" onclick="copyMessage(this)" title="å¤åˆ¶">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    container.appendChild(messageDiv);
    // åªåœ¨ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶æ»šåŠ¨ï¼ŒAIå›å¤ç”±æµå¼å“åº”å¤„ç†
    if (role === 'user') {
        scrollToBottom();
    }
    
    if (isStreaming) {
        return messageDiv.querySelector('.message-content');
    }
    
    return messageDiv;
}

// æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆMarkdownæ”¯æŒï¼‰
function formatMessage(content) {
    if (!content) return '';
    
    // è½¬ä¹‰HTML
    let html = escapeHtml(content);
    
    // ä»£ç å—
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        return `<div class="code-block">
            <div class="code-header">
                <span class="code-lang">${lang || 'text'}</span>
                <button class="code-copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>
            </div>
            <pre><code>${escapeHtml(code.trim())}</code></pre>
        </div>`;
    });
    
    // è¡Œå†…ä»£ç 
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ç²—ä½“
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // æ–œä½“
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // æ ‡é¢˜
    html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
    
    // åˆ—è¡¨
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // æ¢è¡Œ
    html = html.replace(/\n/g, '<br>');

    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// å¤åˆ¶åŠŸèƒ½
function copyMessage(btn) {
    const content = btn.closest('.message-content-wrapper').querySelector('.message-content').innerText;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

function copyCode(btn) {
    const code = btn.closest('.code-block').querySelector('code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'å·²å¤åˆ¶';
        setTimeout(() => btn.textContent = 'å¤åˆ¶', 2000);
    });
}

// è¾“å…¥å¤„ç†
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

// ä¾§è¾¹æ åˆ‡æ¢
document.addEventListener('DOMContentLoaded', () => {
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
    const sidebar = document.getElementById('sidebar');
    
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sidebar.classList.toggle('collapsed');
            
            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });
    }
    
    if (sidebarToggleMobile && sidebar) {
        sidebarToggleMobile.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sidebar.classList.toggle('mobile-open');
        });
    }
    
    // æ¢å¤ä¾§è¾¹æ çŠ¶æ€ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
    if (window.innerWidth > 768) {
        const wasCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (wasCollapsed && sidebar) {
            sidebar.classList.add('collapsed');
        }
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ç§»åŠ¨ç«¯ä¾§è¾¹æ 
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('mobile-open')) {
            if (!sidebar.contains(e.target) && !e.target.closest('.sidebar-toggle-mobile')) {
                sidebar.classList.remove('mobile-open');
            }
        }
    });
});

// æ¸…ç©ºå¯¹è¯
function clearChat() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
        document.getElementById('messagesContainer').innerHTML = `
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">ğŸ‘‹</div>
                <h3>å¯¹è¯å·²æ¸…ç©º</h3>
                <p>å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</p>
            </div>
        `;
    }
}

// å¯¼å‡ºå¯¹è¯
function exportChat() {
    // ä½¿ç”¨åç«¯APIå¯¼å‡ºå®Œæ•´çš„å¯¹è¯è®°å½•
    const url = TokenManager.buildUrl(`/api/workspaces/${workspaceId}/export`);
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('å¯¼å‡ºå¤±è´¥');
            }
            return response.blob();
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${workspaceId}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('å¯¹è¯å·²å¯¼å‡ºä¸ºJSONæ ¼å¼', 'success');
        })
        .catch(error => {
            console.error('å¯¼å‡ºé”™è¯¯:', error);
            showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
        });
}

// é€šçŸ¥ç³»ç»Ÿ
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span class="notification-message">${message}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    `;
    container.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
